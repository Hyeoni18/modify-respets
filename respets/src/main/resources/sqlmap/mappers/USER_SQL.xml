<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.teamx.respets.user.mapper.UserMapper">
	
	<!-- 개인회원가입 -->
    <insert id="insertPersonalJoin" parameterType="map">
    	INSERT INTO PERSONAL_TB VALUES
    	(
    		#{per_email}
    		,'P'||NEXTVAL('PER_SEQ')
    		,#{per_pw}
    		,#{per_name}
    		,#{per_phone}
    		,#{per_file_id}
    		,default
    		,default
    		,NULL
    	)
    </insert>
    
    <!-- 이메일인증성공 -->
	<update id="emailConfirmSuccess" parameterType="String">
		UPDATE PERSONAL_TB 
		SET
			PER_EMCHK='O' 
		WHERE PER_EMAIL=#{per_email}
	</update>
	
	<!-- 기업 회원 가입 시 업종 선택 -->
	<select id="selectBusCategory" resultType="map">
		SELECT CMMN_CD
			, CD_DESC
		FROM CMMN_CODE 
		WHERE GRP_CD='BC00'
	</select>
	
	<!-- 기업 회원 가입 -->
	<insert id="insertBusinessJoin" parameterType="map">
		<selectKey keyProperty="bus_seq" resultType="int" order="BEFORE">
			SELECT NEXTVAL('BUS_SEQ') 
		</selectKey>
		INSERT INTO BUSINESS_TB VALUES
		(
			'B'||#{bus_seq}
			,#{bus_email, jdbcType=VARCHAR}
			,#{bus_pw, jdbcType=VARCHAR}
			,#{bus_name, jdbcType=VARCHAR}
			,#{bus_ceo, jdbcType=VARCHAR}
			,#{bus_lcno, jdbcType=VARCHAR}
			,#{bus_lcno_file_id, jdbcType=VARCHAR}
			,#{bus_phone, jdbcType=VARCHAR}
			,#{bus_post, jdbcType=VARCHAR}
			,#{bus_addr, jdbcType=VARCHAR}
			,#{bus_dtl_addr, jdbcType=VARCHAR}
			,#{bus_file_id, jdbcType=VARCHAR}
			,'O'
			,default
			,default
			,NOW()
		)
	</insert>
	
	<!-- 기업 서비스 가입 -->
	<insert id="insertBusJoinSvc" parameterType="map">
		INSERT INTO SERVICE_TB VALUES
		(
			#{bct_code}
			,#{bus_no}
			,1
			,#{bus_file_id} <!-- 임시 -->
		)
	</insert>

	<!-- 아이디찾기 -->
	<select id="findId" parameterType="map" resultType="map">
		SELECT EMAIL, #{type} as type
		FROM FIND_VIEW 
		WHERE NAME=#{per_name} 
			AND	PHONE=#{per_phone} 
			AND NO LIKE '${type}%' 
	</select>
	
	<!-- 기존 랜덤값 조회 -->
	<select id="findRND" parameterType="map" resultType="map"> 
		SELECT RND_CODE 
		FROM RANDOM_TB 
		WHERE RND_EMAIL=#{email}
	</select>
	
	<!-- 기존 랜덤값 삭제 -->
	<delete id="deleteRND" parameterType="map"> 
		DELETE FROM RANDOM_TB 
		WHERE RND_EMAIL=#{email}
	</delete>
	
	<!-- 새로운 랜덤값 등록 -->
	<insert id="insertRND" parameterType="map">
		INSERT INTO RANDOM_TB
		VALUES
			(
				#{email}
				,#{rndCode}
				,#{type}
				,default
			)
	</insert>
	
	<!-- 로그인 -->
	<select id="loginProcess" parameterType="map" resultType="map">
		SELECT NO
			,EMAIL
			,PW
			,NAME
			,PHONE
			,LEAVE
			,EMCHK
			,LOC
			,PHOTO
		FROM FIND_VIEW 
		WHERE EMAIL=#{per_email} 
			AND PW=#{per_pw}
	</select> 
	
	<!-- 블랙리스트 조회 -->
	<select id="selectBlackList" parameterType="map" resultType="Integer">
		SELECT OUT_NO 
		FROM BLACKLIST_TB 
		WHERE PER_NO=#{no}
	</select>
	
	<!-- 회원 정보 조회 -->
	<select id="selectMyInfo" parameterType="map" resultType="map">
		SELECT *
		FROM PERSONAL_TB 
		WHERE PER_NO = #{no}
	</select>
	
	<!-- 비밀번호 확인 -->
	<select id="myPwCheck" resultType="Integer" parameterType="map">
		SELECT COUNT(*) 
		FROM PERSONAL_TB 
		WHERE PER_NO = #{per_no} 
			AND PER_PW = #{per_pw}
	</select>
	
	<!-- 비밀번호 수정 -->
	<update id="updatePw" parameterType="map">
		UPDATE PERSONAL_TB 
		SET PER_PW = #{per_pw} 
		WHERE PER_NO = #{per_no}
	</update>
	
	<!-- 개인 회원탈퇴 -->
	<update id="deleteUser" parameterType="String">
		UPDATE PERSONAL_TB 
		SET PER_LEAVE = 'O', PER_LTIME = NOW() 
		WHERE PER_NO = #{no}
	</update>
	
</mapper>